<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>思い出カメラ</title>

<!-- Leaflet (CDN) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">

<style>
:root{
  --bg:#000000;
  --panel:#121212;
  --line:#262626;
  --accent:#0095f6;
  --text:#ffffff;
  --muted:#a8a8a8;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0; padding: 0;}
body{
  font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background: var(--bg);
  color:var(--text);
  overscroll-behavior: none;
}

/* ====== Layout Skeleton ====== */
.app{position:fixed;inset:0;display:grid;grid-template-rows:60px 1fr 80px;}

/* ====== Top Bar ====== */
.top{
  position:relative;
  background: var(--bg);
  border-bottom:1px solid var(--line);
  display:flex; align-items:center; justify-content:center;
  z-index: 100;
}
.title{
  font-weight: 700;
  font-size: 18px;
  letter-spacing: 0.5px;
}
.title .jp{ display: inline-block; }

/* ====== Main View ====== */
.view{position:relative; overflow:hidden; height:100%; background: var(--bg);}
.view > .inner{position:absolute; inset:0; display:none; background: var(--bg);}
.view > .inner.active{display:block;}

/* Camera View */
#camera {
    position: relative;
    width: 100%;
    height: 100%;
    background: #000;
    overflow: hidden;
}
#camera video{
    position: absolute;
    top: 50%;
    left: 50%;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: translate(-50%, -50%);
}
.cameraMask{position:absolute; inset:0; pointer-events:none; box-shadow:inset 0 0 0 2px rgba(255,255,255,0.1);}
#cameraOffState {
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    background: #000;
    z-index: 1;
}
#cameraOffState .info-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
    max-width: 100%;
    max-height: 100%;
}
#toggleCameraButton {
  position: absolute; top: 16px; right: 16px;
  width: 44px; height: 44px;
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.6);
  border: 1px solid rgba(255,255,255,0.2);
  color: #fff;
  display: grid; place-items: center;
  cursor: pointer; z-index: 10;
}
#toggleCameraButton svg { width: 24px; height: 24px; }

/* Map View */
#map{position:absolute; inset:0}
.leaflet-container{background:#121212}
.custom-marker-icon {
  --marker-color: #0095f6;
  background-color: rgba(0, 149, 246, 0.3);
  border: 2px solid var(--marker-color);
  box-shadow: 0 0 8px rgba(0, 149, 246, 0.5);
  border-radius: 50%;
  width: 24px!important; height: 24px!important;
  display: flex; justify-content: center; align-items: center;
}
.custom-marker-icon::after {
  content: ''; width: 8px; height: 8px;
  background-color: var(--marker-color);
  border-radius: 50%;
}
.leaflet-popup-content-wrapper { background: #262626; color: #fff; border-radius: 8px; border: none; }
.leaflet-popup-content { font-size: 13px; width: 180px !important; margin: 12px; }
.leaflet-popup-tip { background: #262626; }
.leaflet-popup-content .popup-title { font-size: 14px; font-weight: bold; margin-bottom: 8px; display: block; text-align: center; }
.popup-actions { display: flex; flex-direction: column; gap: 8px; margin-top: 10px;}
.popup-btn {
  display: block; width: 100%; padding: 8px 0; border-radius: 4px;
  text-align: center; text-decoration: none; font-weight: 600; font-size: 12px;
  border: 1px solid transparent; cursor: pointer;
}
.popup-btn.primary { background: var(--accent); color: #fff; }
.popup-btn.secondary { background: transparent; border: 1px solid var(--line); color: #fff; }


/* ====== Album View (Full Feed Style) ====== */
#album {
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

.albumGrid {
    display: flex;
    flex-direction: column;
    /* パディングを0にして画面端まで表示 */
    padding: 0;
    padding-bottom: 100px;
    background: var(--bg);
    gap: 0; /* カード間の隙間もなくす */
}

.card {
  display: flex;
  flex-direction: column;
  background: var(--bg);
  /* 各投稿の下に少し余白を入れる */
  margin-bottom: 16px;
  width: 100%;
}

/* カードヘッダー */
.card-header {
    padding: 10px 12px;
    display: flex;
    align-items: center;
}
.card-avatar {
    width: 32px; height: 32px;
    border-radius: 50%;
    background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    margin-right: 10px;
    position: relative;
}
.card-avatar::after {
    content:''; position:absolute; inset:2px; background:var(--bg); border-radius:50%;
}
.card-title {
    font-weight: 600;
    font-size: 14px;
    color: var(--text);
}

/* 画像部分 */
.card .thumb-container {
    width: 100%;
    /* 背景色を削除 */
    background: transparent;
    position: relative;
}

.card .thumb {
    width: 100%;
    /* 高さは自動（アスペクト比維持） */
    height: auto;
    display: block;
    /* 画像が歪まないようにする */
    object-fit: cover; 
}

/* アクションボタンエリア */
.card-actions {
    padding: 12px 12px 8px;
    display: flex;
    gap: 16px;
}
.action-icon { width: 24px; height: 24px; cursor: pointer; color: var(--text); }

/* キャプションエリア */
.card-content {
    padding: 0 12px 12px;
    font-size: 14px;
    line-height: 1.4;
}
.card-text {
    color: var(--text);
}

/* PC向け調整：PCでは少し幅を制限して中央寄せ */
@media (min-width: 600px) {
    .albumGrid {
        align-items: center;
        padding-top: 20px;
    }
    .card {
        max-width: 470px;
        border: 1px solid var(--line);
        border-radius: 8px;
        margin-bottom: 24px;
    }
    .card-header, .card-actions, .card-content {
        padding-left: 16px;
        padding-right: 16px;
    }
}


/* ====== Modal Overlays ====== */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0, 0, 0, 0.9);
  z-index: 2000;
  display: none;
  justify-content: center;
  align-items: center;
  opacity: 0;
  transition: opacity .3s ease-out;
}
.modal-overlay.show { display: flex; }

.modal-container {
  position: relative;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.modal-close-btn {
  position: absolute; top: 20px; right: 20px;
  width: 40px; height: 40px; background: rgba(0,0,0,0.5);
  border: none; color: #fff;
  border-radius: 50%; cursor: pointer; font-size: 24px;
  display: flex; align-items: center; justify-content: center;
  z-index: 10;
}

.modal-image-wrap {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    padding: 20px 0;
}
.modal-image {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
}

.modal-footer {
    padding: 20px;
    background: rgba(0,0,0,0.8);
    text-align: center;
    color: #fff;
}
.modal-caption { font-size: 16px; font-weight: bold; margin-bottom: 12px; }

/* Modal Controls */
.paging-controls { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 10px;}
.paging-btn {
  background: none; border: 1px solid #fff; color: #fff;
  border-radius: 4px; padding: 8px 16px; cursor: pointer;
}
.paging-btn:disabled { opacity: 0.3; }
#albumPhotoOverlay .modal-actions { display: flex; justify-content: center; }


/* ====== Bottom Controls ====== */
.bottom{
  position:relative;
  background: var(--bg);
  border-top:1px solid var(--line);
  z-index: 100;
}
.controls{
  height:100%; display:grid; grid-template-columns:1fr auto 1fr; align-items:center;
}
.btn{
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
  background:none; border:none; color:var(--muted);
  height: 100%; cursor:pointer;
}
.btn.active { color: var(--text); }
.btn .label{font-size:10px;}
.btn .icon{width:24px; height:24px; stroke-width: 1.5;}

/* Center Button */
.center-btn-wrap{display:grid; place-items:center; height: 100%;}
#centerBtn{
  width:56px; height:56px; border-radius:50%;
  background: var(--bg);
  border: 2px solid var(--text);
  color: var(--text);
  display: grid; place-items: center; padding: 0;
  cursor: pointer;
}
#centerBtn.is-camera-mode {
    background: var(--text);
    color: var(--bg);
}
.center-btn-icon { width: 28px; height: 28px; stroke-width: 1.5; }

/* Toast */
.toast{
    position:fixed; left:50%; bottom:100px; transform:translateX(-50%);
    background:rgba(30, 30, 30, 0.9);
    border:1px solid #333; color:#fff;
    padding:12px 20px; border-radius:24px;
    font-size:14px; font-weight: 500;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
    display:none; z-index: 3000; white-space: nowrap;
}
.toast.show{display:block; animation:fade .25s ease-out}
@keyframes fade{from{opacity:0; transform:translateX(-50%) translateY(10px)} to{opacity:1; transform:translateX(-50%)}}

/* Fade Transition */
.fade-enter{animation:fadeIn .2s ease-out}
@keyframes fadeIn{from{opacity:0} to{opacity:1}}

/* Safe Area */
@supports(padding:max(0px)){
  .app { grid-template-rows: calc(60px + env(safe-area-inset-top)) 1fr calc(80px + env(safe-area-inset-bottom)); }
  .top{padding-top:env(safe-area-inset-top)}
  .bottom{padding-bottom:env(safe-area-inset-bottom)}
  .toast { bottom: calc(100px + env(safe-area-inset-bottom)); }
}
</style>
</head>
<body>
  <div class="app">
    <!-- ===== Top Header ===== -->
    <header class="top">
      <div class="title">
        <div class="jp">思い出カメラ</div>
      </div>
    </header>

    <!-- ===== Center View (switchable) ===== -->
    <main class="view">
      <!-- Camera View -->
      <section id="camera" class="inner active fade-enter">
        <video id="video" autoplay playsinline muted></video>
        <div class="cameraMask"></div>
        <div id="cameraOffState">
          <img src="../info.png" alt="Info" class="info-image">
        </div>
        <button id="toggleCameraButton" aria-label="Toggle Camera">
            <!-- Icon inserted by JS -->
        </button>
      </section>

      <!-- Map View -->
      <section id="mapview" class="inner">
        <div id="map"></div>
      </section>

      <!-- Album View -->
      <section id="album" class="inner">
        <div class="albumGrid" id="albumGrid">
            <!-- Photos will be inserted here -->
        </div>
      </section>
    </main>

    <!-- Found Photo Modal (Shutter Result) -->
    <div id="foundPhotoOverlay" class="modal-overlay">
        <div class="modal-container">
            <button class="modal-close-btn" aria-label="閉じる">&times;</button>
            <div class="modal-image-wrap">
                <img id="foundPhotoImage" class="modal-image" src="" alt="発見された写真">
            </div>
            <div class="modal-footer">
                <div class="modal-caption">思い出の写真</div>
                <div class="main" id="foundPhotoCaptionMain"></div>
                <div class="paging-controls">
                    <button id="prevPhotoBtn" class="paging-btn">◀</button>
                    <span id="pagingCounter"></span>
                    <button id="nextPhotoBtn" class="paging-btn">▶</button>
                </div>
            </div>
        </div>
    </div>
      
    <!-- Album Photo Modal (Detail View) -->
    <div id="albumPhotoOverlay" class="modal-overlay">
        <div class="modal-container">
            <button class="modal-close-btn" aria-label="閉じる">&times;</button>
            <div class="modal-image-wrap">
                <img id="albumPhotoImage" class="modal-image" src="" alt="アルバムの写真">
            </div>
            <div class="modal-footer">
                <div class="modal-caption">思い出の写真</div>
                <div class="main" id="albumPhotoCaptionMain"></div>
                <div class="modal-actions" style="margin-top:16px;">
                    <button id="albumModalMapBtn" class="popup-btn primary" style="max-width:200px; margin:0 auto;">場所を確認する</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== Bottom Tab Bar ===== -->
    <footer class="bottom">
      <div class="controls">
        <button class="btn" id="btnAlbum" aria-label="アルバム">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
        </button>
        <div class="center-btn-wrap">
          <button id="centerBtn" aria-label="カメラ/シャッター">
            <!-- Icon inserted by JS -->
          </button>
        </div>
        <button class="btn" id="btnMap" aria-label="マップ">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></svg>
        </button>
      </div>
    </footer>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo" crossorigin="anonymous"></script>
  
  <script>
  document.addEventListener('DOMContentLoaded', () => {

    // ====== DOM Elements ======
    const views = { camera: document.querySelector('#camera'), map: document.querySelector('#mapview'), album: document.querySelector('#album') };
    const toastEl = document.querySelector('#toast');
    const videoEl = document.querySelector('#video');
    const cameraOffState = document.querySelector('#cameraOffState');
    const toggleCameraButton = document.querySelector('#toggleCameraButton');
    const centerBtn = document.querySelector('#centerBtn');
    
    // Found Photo Modal
    const foundPhotoOverlay = document.querySelector('#foundPhotoOverlay');
    const foundPhotoImage = document.querySelector('#foundPhotoImage');
    const foundPhotoCaptionMain = document.querySelector('#foundPhotoCaptionMain');
    const pagingCounter = document.querySelector('#pagingCounter');
    const prevBtn = document.querySelector('#prevPhotoBtn');
    const nextBtn = document.querySelector('#nextPhotoBtn');

    // Album Photo Modal
    const albumPhotoOverlay = document.querySelector('#albumPhotoOverlay');
    const albumPhotoImage = document.querySelector('#albumPhotoImage');
    const albumPhotoCaptionMain = document.querySelector('#albumPhotoCaptionMain');
    const albumModalMapBtn = document.querySelector('#albumModalMapBtn');

    // Tab Buttons
    const btnAlbum = document.querySelector('#btnAlbum');
    const btnMap = document.querySelector('#btnMap');


    // ====== App State ======
    let allPhotoData = [];
    let map;
    const markersByUniqueId = {};
    let foundPhotos = [];
    let currentFoundIndex = 0;
    const FIND_RADIUS_METERS = 15;
    let cameraStream = null;
    let isCameraOn = false;
    let currentView = 'camera';
    let currentUserLocationMarker = null;

    // Icons
    const shutterIcon = `<svg class="center-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"></circle></svg>`;
    const cameraToggleIcon = `<svg class="center-btn-icon is-camera-mode" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>`;
    const cameraOnIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>`;
    const infoIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`;

    // ====== Utilities ======
    const toast = (text, duration = 2000) => {
        toastEl.textContent = text;
        toastEl.classList.add('show');
        setTimeout(() => toastEl.classList.remove('show'), duration);
    };

    const getDistance = (lat1, lon1, lat2, lon2) => {
        const R = 6371e3;
        const φ1 = lat1 * Math.PI / 180; const φ2 = lat2 * Math.PI / 180;
        const Δφ = (lat2 - lat1) * Math.PI / 180; const Δλ = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    };

    // ====== UI Update ======
    const updateCenterButtonUI = (viewName) => {
        if (viewName === 'camera') {
            centerBtn.innerHTML = shutterIcon;
            centerBtn.classList.remove('is-camera-mode');
        } else {
            centerBtn.innerHTML = cameraToggleIcon;
            centerBtn.classList.add('is-camera-mode');
        }
    };
    
    const updateActiveTab = (viewName) => {
        btnAlbum.classList.remove('active');
        btnMap.classList.remove('active');
        
        if (viewName === 'album') btnAlbum.classList.add('active');
        if (viewName === 'map') btnMap.classList.add('active');
    };

    // ====== View Management ======
    const showView = (name) => {
        if (currentView === 'camera' && name !== 'camera') {
            stopCamera();
        }
        currentView = name;

        Object.entries(views).forEach(([key, el]) => {
            const isActive = (key === name);
            el.classList.toggle('active', isActive);
            // Stop animation if needed, keeping it simple here
            if (isActive) {
                el.classList.add('fade-enter');
                setTimeout(() => el.classList.remove('fade-enter'), 200);
            }
        });
        
        updateCenterButtonUI(name);
        updateActiveTab(name);
    };

    // ====== Data Loading ======
    const loadPhotoData = async () => {
        try {
            const response = await fetch('./suzu_data.csv');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const csvText = await response.text();
            const lines = csvText.trim().split('\n');
            const header = lines.shift().split(',').map(h => h.trim());
            const [idIndex, textIndex, latIndex, longIndex] = ['id', 'text', 'lat', 'long'].map(h => header.indexOf(h));
            if ([idIndex, textIndex, latIndex, longIndex].includes(-1)) throw new Error("CSV header missing required columns");
            
            allPhotoData = lines.map((line, index) => {
                const values = line.split(',');
                if (values.length < header.length) return null;
                return {
                    uniqueId: index,
                    id: values[idIndex]?.trim(),
                    text: values[textIndex]?.trim(),
                    lat: parseFloat(values[latIndex]),
                    long: parseFloat(values[longIndex])
                };
            }).filter(p => p && p.id && !isNaN(p.lat) && !isNaN(p.long));
            
            renderAlbum(); // Render album immediately after data load
            
        } catch (error) {
            console.error("Data load error:", error);
            toast('写真データの読み込みに失敗しました。');
        }
    };
    
    // ====== Camera Control ======
    const updateCameraUI = (isOn) => {
        isCameraOn = isOn;
        cameraOffState.style.display = isOn ? 'none' : 'flex';
        videoEl.style.display = isOn ? 'block' : 'none';
        toggleCameraButton.innerHTML = isOn ? infoIcon : cameraOnIcon;
        toggleCameraButton.classList.toggle('is-on', isOn);
    };

    const startCamera = async () => {
        if (cameraStream) return;
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
            cameraStream = stream;
            videoEl.srcObject = stream;
            updateCameraUI(true);
        } catch (err) {
            toast('カメラの起動に失敗しました');
            console.warn('Camera Error:', err);
            updateCameraUI(false);
        }
    };

    const stopCamera = () => {
        if (!cameraStream) return;
        cameraStream.getTracks().forEach(track => track.stop());
        videoEl.srcObject = null;
        cameraStream = null;
        updateCameraUI(false);
    };

    // ====== Map ======
    const showCurrentUserLocation = () => {
        if (!map) return;
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const latLng = [position.coords.latitude, position.coords.longitude];
                if (currentUserLocationMarker) {
                    currentUserLocationMarker.setLatLng(latLng);
                } else {
                    currentUserLocationMarker = L.circleMarker(latLng, {
                        radius: 8, fillColor: "#4285F4", color: "#fff",
                        weight: 2, opacity: 1, fillOpacity: 0.9
                    }).addTo(map);
                }
                map.setView(latLng, 15); // Optional: center map on user
            },
            () => { /* silent fail or toast */ }
        );
    };

    const initMapOnce = () => {
        if (map) return;
        map = L.map('map', { zoomControl: false, attributionControl: false }).setView([37.444, 137.264], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map); // Dark theme map
        
        const customIcon = L.divIcon({ className: 'custom-marker-icon' });
        const markersLayer = L.layerGroup().addTo(map);
        
        allPhotoData.forEach(p => {
            const popupContent = `
                <div class="popup-title">${p.text}</div>
                <div class="popup-actions">
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.long}" target="_blank" rel="noopener" class="popup-btn primary">ここに行く</a>
                    <button class="popup-btn secondary" data-unique-id="${p.uniqueId}">写真を見る</button>
                </div>`;
            const m = L.marker([p.lat, p.long], { icon: customIcon }).addTo(markersLayer).bindPopup(popupContent);
            markersByUniqueId[p.uniqueId] = m;
        });
    };

    // ====== Album (Feed Style) ======
    const renderAlbum = () => {
        const grid = document.querySelector('#albumGrid');
        if (!allPhotoData.length) return;
        
        grid.innerHTML = allPhotoData.map(p => `
            <div class="card" data-unique-id="${p.uniqueId}">
                <div class="card-header">
                    <div class="card-avatar"></div>
                    <div class="card-title">${p.text}</div>
                </div>
                <div class="thumb-container">
                    <img class="thumb" src="./images/${p.id}" loading="lazy" alt="${p.text}">
                </div>
                <div class="card-actions">
                    <svg class="action-icon like-btn" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                    <svg class="action-icon map-btn" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon></svg>
                </div>
                <div class="card-content">
                    <span class="card-text"><strong>思い出カメラ</strong> ${p.text}</span>
                </div>
            </div>
        `).join('');
    };
    
    const showPhotoInAlbumModal = (uniqueId) => {
        const photo = allPhotoData.find(p => p.uniqueId === uniqueId);
        if (!photo) return;
        albumPhotoImage.src = `./images/${photo.id}`;
        albumPhotoCaptionMain.textContent = photo.text;
        albumModalMapBtn.dataset.uniqueId = uniqueId;
        
        // Show modal
        const overlay = document.querySelector('#albumPhotoOverlay');
        overlay.classList.add('show');
        setTimeout(() => { overlay.style.opacity = '1'; }, 10);
    };

    const flyToPoint = (uniqueId) => {
        const point = allPhotoData.find(p => p.uniqueId === uniqueId);
        if (!point) return;
        showView('map');
        initMapOnce();
        showCurrentUserLocation();
        
        const targetMarker = markersByUniqueId[uniqueId];
        if (map && targetMarker) {
            map.flyTo([point.lat, point.long], 16, { animate: true, duration: 1.0 });
            setTimeout(() => { targetMarker.openPopup(); }, 1200);
        }
    };

    // ====== Shutter & Photo Finding ======
    const handleShutterClick = () => {
        if (!isCameraOn) {
            toast('カメラを起動してください');
            return;
        }
        toast('現在地から思い出を探しています...');
        navigator.geolocation.getCurrentPosition(
            (position) => {
                foundPhotos = allPhotoData.filter(p => getDistance(position.coords.latitude, position.coords.longitude, p.lat, p.long) <= FIND_RADIUS_METERS);
                if (foundPhotos.length > 0) {
                    toast(`近くで ${foundPhotos.length}枚の思い出を発見！`);
                    displayFoundPhoto(0);
                    // Show found modal
                    const overlay = document.querySelector('#foundPhotoOverlay');
                    overlay.classList.add('show');
                    setTimeout(() => { overlay.style.opacity = '1'; }, 10);
                } else {
                    toast('この近くには思い出の写真がないようです');
                }
            },
            (error) => { toast('位置情報の取得に失敗しました'); },
            { enableHighAccuracy: true }
        );
    };
    
    const displayFoundPhoto = (index) => {
        currentFoundIndex = index;
        const photo = foundPhotos[index];
        foundPhotoImage.src = `./images/${photo.id}`;
        foundPhotoCaptionMain.textContent = photo.text;
        pagingCounter.textContent = `${index + 1} / ${foundPhotos.length}`;
        prevBtn.disabled = index === 0;
        nextBtn.disabled = index === foundPhotos.length - 1;
    };

    // ====== Event Listeners ======
    btnMap.addEventListener('click', () => { showView('map'); initMapOnce(); showCurrentUserLocation(); });
    btnAlbum.addEventListener('click', () => { showView('album'); }); // Album is rendered on load

    // Album interactions
    document.querySelector('#albumGrid').addEventListener('click', e => {
        const card = e.target.closest('.card');
        const mapBtn = e.target.closest('.map-btn');
        
        if (mapBtn && card) {
            // Map icon clicked in card -> Go to map
            flyToPoint(parseInt(card.dataset.uniqueId, 10));
        } else if (card) {
            // Card clicked -> Show Modal
            showPhotoInAlbumModal(parseInt(card.dataset.uniqueId, 10));
        }
    });

    // Map popup interactions
    document.querySelector('#map').addEventListener('click', e => {
        const btn = e.target.closest('.popup-btn.secondary');
        if (btn && btn.dataset.uniqueId) {
             showPhotoInAlbumModal(parseInt(btn.dataset.uniqueId, 10));
        }
    });
    
    // Main Controls
    centerBtn.addEventListener('click', () => {
        if (currentView === 'camera') handleShutterClick();
        else showView('camera');
    });
    toggleCameraButton.addEventListener('click', () => {
        if (isCameraOn) stopCamera(); else startCamera();
    });
    
    // Modals
    const hideModal = (overlay) => {
        overlay.style.opacity = '0';
        setTimeout(() => { overlay.classList.remove('show'); }, 300);
    };
    document.querySelectorAll('.modal-close-btn').forEach(btn => {
        btn.addEventListener('click', (e) => hideModal(e.target.closest('.modal-overlay')));
    });
    
    prevBtn.addEventListener('click', () => { if(currentFoundIndex > 0) displayFoundPhoto(currentFoundIndex - 1); });
    nextBtn.addEventListener('click', () => { if(currentFoundIndex < foundPhotos.length - 1) displayFoundPhoto(currentFoundIndex + 1); });
    
    albumModalMapBtn.addEventListener('click', (e) => {
        hideModal(document.querySelector('#albumPhotoOverlay'));
        flyToPoint(parseInt(e.target.dataset.uniqueId, 10));
    });

    // ====== Initialization ======
    const initializeApp = async () => {
        updateCenterButtonUI('camera');
        updateCameraUI(false);
        updateActiveTab('camera');
        await loadPhotoData();
    };

    initializeApp();
  });
  </script>
</body>
</html>
